---
- name: test connectivity
  win_ping:

- name: upgrade and update windows
  block:

  - name: allow windows feature updates
    ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: ProductVersion
      data: Windows 11
      type: string

  - name: specify target release version
    ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: TargetReleaseVersion
      data: 1
      type: dword

  - name: specify target release version info
    ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
      name: TargetReleaseVersionInfo
      data: '{{ desired_w11_hotfix }}'
      type: string

  - name: install upgrades and updates
    ansible.windows.win_updates:
      category_names: ["*"]
      reboot: true

- name: configure windows
  block:

  - name: set windows system ui to dark mode
    win_regedit:
      path: "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize"
      name: "SystemUsesLightTheme"
      data: 0
      type: dword

  - name: set windows apps to dark mode
    win_regedit:
      path: "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize"
      name: "AppsUseLightTheme"
      data: 0
      type: dword

  - name: schedule task - kill unwanted processes loop
    community.windows.win_scheduled_task:
      name: KillUnwantedProcessesLoop
      actions:
        - path: powershell.exe
          arguments: -NoProfile -WindowStyle Hidden -Command "while ($true) { 'msedge','searchhost','gameassist','gamebar' | ForEach-Object { Get-Process -Name $_ -ErrorAction SilentlyContinue | Stop-Process -Force }; Start-Sleep -Seconds 1 }"
      triggers:
        - type: boot
      username: SYSTEM
      run_level: highest
      state: present
      enabled: yes

- name: install software
  block:

  - name: ensure chocolatey is installed
    chocolatey.chocolatey.win_chocolatey:
      name:
        - chocolatey
      state: present

  - name: install geforce-game-ready-driver
    win_chocolatey:
      name: nvidia-display-driver
      version: '{{ desired_nvda_version }}'
      state: present
      # force: true
      params:
        '/NVApp /NoAudio /NoUSBC'
        # '/NoAudio /NoUSBC'

  - name: install firefox
    block:

    - name: install package
      win_chocolatey:
        name: firefox
        state: present
        params:
          '/NoDesktopShortcut'

    - name: ensure distribution folder exists
      win_file:
        path: C:\Program Files\Mozilla Firefox\distribution
        state: directory

    - name: deploy policies.json
      win_copy:
        content: |
          {
            "policies": {
              "SearchEngines": {
                "Default": "DuckDuckGo"
              },
              "Bookmarks": [
                {
                  "Title": "Grok",
                  "URL": "https://grok.com"
                },
                {
                  "Title": "ChatGPT",
                  "URL": "https://chat.openai.com"
                }
              ],
              "Extensions": {
                "Install": [
                  "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi"
                ],
                "Locked": ["ublock-origin@raymondhill.net"]
              },
              "ExtensionSettings": {
                "ublock-origin@raymondhill.net": {
                  "install_sources": ["https://addons.mozilla.org/"],
                  "run_in_private_windows": true
                }
              }
            }
          }
        dest: "C:\\Program Files\\Mozilla Firefox\\distribution\\policies.json"
        force: yes

  - name: install blender
    win_chocolatey:
      name: blender
      version: '{{ desired_blender_version }}'
      state: present

  - name: install audacity
    win_chocolatey:
      name: audacity
      version: '{{ desired_audacity_version }}'
      state: present

  - name: install unity hub
    win_chocolatey:
      name: unity-hub
      state: present

  - name: install visual studio community 2022
    win_chocolatey:
      name: visualstudio2022community
      # package_params: >
      #   --add Microsoft.VisualStudio.Workload.ManagedGame
      #   --add Microsoft.VisualStudio.Workload.NativeGame
      #   --add Microsoft.VisualStudio.Workload.NetWeb
      state: present

  - name: install wsl2
    win_chocolatey:
      name: wsl2
      state: present
    register: wsl2_result 

  - name: reboot
    win_reboot:
    when: wsl2_result.changed

  - name: install ubuntu wsl
    win_chocolatey:
      name: wsl-ubuntu-2004
      state: present
